{% extends 'core/base.html' %}

{% block title %}Chat - {{ room_name }}{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Chat Container -->
    <div class="col-12">
        <div class="card" style="height: 80vh;">
            <!-- Chat Header -->
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Chat Room: <strong>{{ room_name }}</strong></h5>
                        <small>Room ID: <code>chat_{{ room_name }}</code></small>
                    </div>
                    <div>
                        <span class="status-indicator connected" id="connectionStatus"></span>
                        <small id="statusText">Connecting...</small>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="card-body d-flex flex-column" style="overflow-y: auto;">
                <div id="messagesContainer" class="flex-grow-1" style="overflow-y: auto; min-height: 500px;">
                    <!-- Messages will be inserted here -->
                    <div class="text-center text-muted mt-5">
                        <p>ðŸ’¬ No messages yet. Start the conversation!</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input Footer -->
            <div class="card-footer bg-light">
                <form id="messageForm" class="d-flex gap-2">
                    <!-- Username Input -->
                    <input 
                        type="text" 
                        id="username" 
                        class="form-control" 
                        placeholder="Your name" 
                        value="Guest"
                        style="max-width: 150px;"
                    >
                    
                    <!-- Message Input -->
                    <input 
                        type="text" 
                        id="messageInput" 
                        class="form-control flex-grow-1" 
                        placeholder="Type a message..." 
                        autocomplete="off"
                    >
                    
                    <!-- Send Button -->
                    <button type="submit" class="btn btn-primary">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Message Template (Hidden) -->
<template id="messageTemplate">
    <div class="message-item mb-3 p-3 bg-light rounded">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <strong class="text-primary" data-username></strong>
                <small class="text-muted ms-2" data-timestamp></small>
            </div>
        </div>
        <p class="mb-0 mt-2" data-message></p>
    </div>
</template>

<!-- Notification Template (Hidden) -->
<template id="notificationTemplate">
    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
        <strong>ðŸ“¢ System:</strong> <span data-message></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</template>

<style>
    .message-item {
        border-left: 4px solid #007bff;
        animation: slideIn 0.3s ease-in-out;
    }

    .message-item:hover {
        background-color: #e7f3ff !important;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #messagesContainer {
        scroll-behavior: smooth;
    }
</style>

<!-- JavaScript -->
<script>
    /**
     * ===================================================================
     * CHAT ROOM - WebSocket Client Implementation
     * ===================================================================
     * 
     * This script handles the WebSocket connection to the chat room consumer.
     * 
     * Functionality:
     * 1. Connect to WebSocket server
     * 2. Send messages to server
     * 3. Receive and display messages
     * 4. Handle connection status
     * 5. Display system notifications
     * 
     * WebSocket Protocol Documentation:
     * - https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
     * - https://channels.readthedocs.io/
     * 
     * ===================================================================
     */

    // Configuration
    const config = {
        roomName: '{{ room_name }}',
        wsScheme: '{{ ws_scheme }}',
        host: '{{ host }}',
        debug: true
    };

    // DOM Elements
    const elements = {
        messageForm: document.getElementById('messageForm'),
        messageInput: document.getElementById('messageInput'),
        username: document.getElementById('username'),
        messagesContainer: document.getElementById('messagesContainer'),
        statusText: document.getElementById('statusText'),
        messageTemplate: document.getElementById('messageTemplate'),
        notificationTemplate: document.getElementById('notificationTemplate'),
    };

    // WebSocket Connection
    let chatSocket = null;
    let isConnected = false;

    /**
     * Initialize WebSocket connection to chat room
     * 
     * Connection flow:
     * 1. Build WebSocket URL from config
     * 2. Create WebSocket instance
     * 3. Set up event handlers (open, close, message, error)
     * 4. Handle initial connection
     */
    function initializeWebSocket() {
        try {
            // Build WebSocket URL
            // Format: ws://localhost:8000/ws/chat/{room_name}/
            const wsUrl = `${config.wsScheme}://${config.host}/ws/chat/${config.roomName}/`;

            log('INFO', 'Connecting to WebSocket', wsUrl);

            // Create WebSocket connection
            chatSocket = new WebSocket(wsUrl);

            // ================================================================
            // WebSocket Event Handlers
            // ================================================================

            /**
             * onopen: Fired when the WebSocket connection is established
             */
            chatSocket.onopen = function(e) {
                isConnected = true;
                updateConnectionStatus(true, 'connectionStatus');
                elements.statusText.textContent = 'Connected âœ“';
                elements.statusText.className = 'text-success';
                log('INFO', 'WebSocket connection established');
                
                showToast('Connected to chat room', 'success');
            };

            /**
             * onmessage: Fired when the server sends a message
             * 
             * Message structure:
             * {
             *     "type": "chat_message|notification|error",
             *     "message": "...",
             *     "username": "...",
             *     "timestamp": "..."
             * }
             */
            chatSocket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    log('DEBUG', 'Message received', data);

                    switch (data.type) {
                        case 'chat_message':
                            displayMessage(data);
                            break;
                        case 'notification':
                            displayNotification(data);
                            break;
                        case 'error':
                            showToast(data.message, 'error');
                            break;
                        default:
                            log('WARNING', 'Unknown message type', data.type);
                    }
                } catch (error) {
                    log('ERROR', 'Failed to parse message', error);
                }
            };

            /**
             * onclose: Fired when the WebSocket connection is closed
             */
            chatSocket.onclose = function(e) {
                isConnected = false;
                updateConnectionStatus(false, 'connectionStatus');
                elements.statusText.textContent = 'Disconnected';
                elements.statusText.className = 'text-danger';
                log('INFO', 'WebSocket connection closed', e.code);
                
                showToast('Disconnected from chat room', 'warning');
                
                // Attempt to reconnect after 3 seconds
                setTimeout(initializeWebSocket, 3000);
            };

            /**
             * onerror: Fired when a WebSocket error occurs
             */
            chatSocket.onerror = function(error) {
                log('ERROR', 'WebSocket error occurred', error);
                showToast('Connection error occurred', 'error');
            };

        } catch (error) {
            log('ERROR', 'Failed to initialize WebSocket', error);
            showToast('Failed to connect to server', 'error');
        }
    }

    /**
     * Send message to WebSocket server
     * 
     * Message format sent:
     * {
     *     "type": "chat_message",
     *     "message": "user message",
     *     "username": "user name"
     * }
     */
    function sendMessage() {
        if (!isConnected) {
            showToast('Not connected to server', 'warning');
            return;
        }

        const message = elements.messageInput.value.trim();
        const username = elements.username.value.trim() || 'Guest';

        // Validate message
        if (!message) {
            showToast('Please enter a message', 'warning');
            return;
        }

        if (message.length > 1000) {
            showToast('Message is too long (max 1000 characters)', 'warning');
            return;
        }

        try {
            // Create message object
            const messageData = {
                type: 'chat_message',
                message: message,
                username: username
            };

            // Send to server
            chatSocket.send(JSON.stringify(messageData));

            log('INFO', 'Message sent', messageData);

            // Clear input
            elements.messageInput.value = '';
            elements.messageInput.focus();

        } catch (error) {
            log('ERROR', 'Failed to send message', error);
            showToast('Failed to send message', 'error');
        }
    }

    /**
     * Display chat message in the UI
     * 
     * Args:
     *     data (object): Message data from server
     */
    function displayMessage(data) {
        // Clear placeholder message if this is the first message
        if (elements.messagesContainer.querySelector('.text-muted')) {
            elements.messagesContainer.innerHTML = '';
        }

        // Clone message template
        const messageEl = elements.messageTemplate.content.cloneNode(true);

        // Set message data
        messageEl.querySelector('[data-username]').textContent = data.username || 'Unknown';
        messageEl.querySelector('[data-message]').textContent = data.message;
        
        // Format timestamp
        if (data.timestamp) {
            const time = new Date(data.timestamp).toLocaleTimeString();
            messageEl.querySelector('[data-timestamp]').textContent = time;
        }

        // Add to container
        elements.messagesContainer.appendChild(messageEl);

        // Scroll to bottom
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;

        log('DEBUG', 'Message displayed');
    }

    /**
     * Display system notification (user join/leave)
     * 
     * Args:
     *     data (object): Notification data from server
     */
    function displayNotification(data) {
        // Clone notification template
        const notifEl = elements.notificationTemplate.content.cloneNode(true);

        // Set notification message
        notifEl.querySelector('[data-message]').textContent = data.message;

        // Add to container
        elements.messagesContainer.appendChild(notifEl);

        // Scroll to bottom
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;

        log('DEBUG', 'Notification displayed');
    }

    /**
     * Setup event listeners
     */
    function setupEventListeners() {
        // Form submission
        elements.messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });

        // Enter key in message input (without Shift)
        elements.messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    /**
     * Initialize the chat room when page loads
     */
    document.addEventListener('DOMContentLoaded', function() {
        log('INFO', 'Initializing chat room');
        setupEventListeners();
        initializeWebSocket();
    });

    /**
     * Cleanup on page unload
     */
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close();
        }
    });
</script>
{% endblock %}
